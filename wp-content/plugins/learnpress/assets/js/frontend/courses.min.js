import API from"../api";import{lpAddQueryArgs,lpFetchAPI,lpGetCurrentURLNoParam}from"../utils";import Cookies from"../utils/cookies";"undefined"!=typeof lpData&&"undefined"!=typeof lpSettingCourses||console.log("lpData || lpSettingCourses is undefined"),window.lpArchiveRequestCourse=e=>{window.lpCourseList.updateEventTypeBeforeFetch("filter"),window.lpCourseList.triggerFetchAPI(e)},document.addEventListener("change",(function(e){const t=e.target;window.lpCourseList.onChangeSortBy(e,t),window.lpCourseList.onChangeTypeLayout(e,t)})),document.addEventListener("click",(function(e){const t=e.target;window.lpCourseList.clickLoadMore(e,t),window.lpCourseList.clickNumberPage(e,t)})),document.addEventListener("scroll",(function(e){const t=e.target;window.lpCourseList.scrollInfinite(e,t)})),document.addEventListener("keyup",(function(e){const t=e.target;window.lpCourseList.searchCourse(e,t)})),document.addEventListener("submit",(function(e){const t=e.target;window.lpCourseList.searchCourse(e,t)})),window.lpCourseList=(()=>{const e="lp-archive-courses",t="learn-press-courses",r="lp-archive-course-skeleton",o="courses-page-result",n=parseInt(lpSettingCourses.lpArchiveLoadAjax||0),s=1===parseInt(lpSettingCourses.lpArchiveNoLoadAjaxFirst),a=lpData.urlParams||[],i=lpGetCurrentURLNoParam();let c={};const l=lpSettingCourses.lpArchivePaginationType||"number";let u,d,p=!1;const f=(e,t={})=>{const r=lpAddQueryArgs(API.frontend.apiCourses,e);let o={};0!==parseInt(lpData.user_id)&&(o={headers:{"X-WP-Nonce":lpData.nonce}}),lpFetchAPI(r,o,t)};return{init:()=>{const e={},t=window.location.search,r=new URLSearchParams(t);for(const[t,o]of r.entries())e[t]=o;c={...a,...e},c.paged=parseInt(c.paged||1),isNaN(c.paged)&&(c.paged=1),s&&"number"!==l&&(c.paged=1),window.localStorage.setItem("lp_filter_courses",JSON.stringify(c))},updateEventTypeBeforeFetch:e=>{u=e},onChangeSortBy:(e,t)=>{if(!t.classList.contains("courses-order-by"))return;e.preventDefault();const r=JSON.parse(window.localStorage.getItem("lp_filter_courses"))||{};r.order_by=t.value||"","undefined"!=typeof lpSettingCourses&&lpData.is_course_archive&&lpSettingCourses.lpArchiveLoadAjax?window.lpCourseList.triggerFetchAPI(r):window.location.href=lpAddQueryArgs(i,r)},onChangeTypeLayout:(r,o)=>{if("lp-switch-layout-btn"!==o.getAttribute("name"))return;const n=o.closest(`.${e}`);if(!n)return;const s=n.querySelector(`.${t}`);if(!s)return;r.preventDefault();const a=o.value;a&&(s.dataset.layout=a,Cookies.set("courses-layout",a))},clickNumberPage:(t,r)=>{if(!n||parseInt(lpSettingCourses.noLoadCoursesJs))return;if(r.classList.contains("page-numbers")){if(!r.closest(`.${e}`))return;t.preventDefault();const o=c.paged;return r.classList.contains("prev")?c.paged=o-1:r.classList.contains("next")?c.paged=o+1:c.paged=parseInt(r.textContent),u="number",void window.lpCourseList.triggerFetchAPI(c)}const o=r.closest(".page-numbers");o&&(t.preventDefault(),o.click())},clickLoadMore:(r,o)=>{if(!o.classList.contains("courses-btn-load-more"))return;const n=o.closest(`.${e}`);if(!n)return;n.querySelector(`.${t}`)&&(r.preventDefault(),++c.paged,u="load-more",window.lpCourseList.triggerFetchAPI(c))},scrollInfinite:(t,r)=>{const o=document.querySelector(`.${e}`);if(!o)return;const n=o.querySelector(".courses-load-infinite");if(!n)return;new IntersectionObserver((function(e){for(const t of e)if(t.isIntersecting){if(p)return;++c.paged,u="infinite",window.lpCourseList.triggerFetchAPI(c)}})).observe(n)},triggerFetchAPI:r=>{const o=document.querySelector(`.${e}`);if(!o)return;const n=o.querySelector(`.${t}`);if(!n)return;let s;switch(c=r,u){case"load-more":s=window.lpCourseList.callBackPaginationTypeLoadMore(o,n);break;case"infinite":s=window.lpCourseList.callBackPaginationTypeInfinite(o,n);break;case"custom":s=r.customCallBack||!1;break;default:s=window.lpCourseList.callBackFilter(r,o,n)}s&&f(r,s)},callBackFilter:(t,n,s)=>{if(!s)return;const a=s.querySelector(`.${r}`);return{before:()=>{window.history.pushState("","",lpAddQueryArgs(i,t)),window.localStorage.setItem("lp_filter_courses",JSON.stringify(t)),a&&(a.style.display="block")},success:e=>{s.querySelectorAll(`:not(.${r})`).forEach((e=>{e.closest(`.${r}`)||e.remove()})),s.insertAdjacentHTML("afterbegin",e.data.content||"");const t=document.querySelector(".learn-press-pagination");t&&t.remove();const n=e.data.pagination||"";s.insertAdjacentHTML("afterend",n);const a=document.querySelector(`.${o}`);a&&(a.innerHTML=e.data.from_to||"")},error:e=>{s.innerHTML+=`<div class="lp-ajax-message error" style="display:block">${e.message||"Error"}</div>`},completed:()=>{a&&(a.style.display="none");s.closest(`.${e}`).scrollIntoView({behavior:"smooth"})}}},callBackPaginationTypeLoadMore:(e,t)=>{if(!t||!e)return!1;const r=e.querySelector(".courses-btn-load-more");let n;return r&&(n=r.querySelector(".lp-loading-circle")),{before:()=>{r&&(n.classList.remove("hide"),r.setAttribute("disabled","disabled"))},success:e=>{t.insertAdjacentHTML("beforeend",e.data.content||""),t.insertAdjacentHTML("afterend",e.data.pagination||"");const r=document.querySelector(`.${o}`);r&&(r.innerHTML=e.data.from_to||"")},error:e=>{t.innerHTML+=`<div class="lp-ajax-message error" style="display:block">${e.message||"Error"}</div>`},completed:()=>{r&&(n.classList.add("hide"),r.remove())}}},callBackPaginationTypeInfinite:(e,t)=>{if(!t||!t)return;const r=e.querySelector(".courses-load-infinite");if(!r)return;const n=r.querySelector(".lp-loading-circle");return p=!0,r.classList.remove("courses-load-infinite"),{before:()=>{n.classList.remove("hide")},success:e=>{t.insertAdjacentHTML("beforeend",e.data.content||""),e.data.pagination&&t.insertAdjacentHTML("afterend",e.data.pagination||"");const r=document.querySelector(`.${o}`);r&&(r.innerHTML=e.data.from_to||"")},error:e=>{t.innerHTML+=`<div class="lp-ajax-message error" style="display:block">${e.message||"Error"}</div>`},completed:()=>{r.remove(),p=!1}}},searchCourse:(r,o)=>{if("c_search"===o.name){r.preventDefault();const e=o.closest("form.search-courses");if(!e)return;return void e.querySelector('button[type="submit"]').click()}if(!o.classList.contains("search-courses"))return;const n=o;r.preventDefault();const s=n.closest(`.${e}`);if(!s)return;if(!s.querySelector(`.${t}`))return;const a=n.querySelector("input[name=c_search]").value;(!a||a&&a.length>2)&&(void 0!==d&&clearTimeout(d),d=setTimeout((function(){u="filter",c.c_search=a,c.paged=1,window.lpCourseList.triggerFetchAPI(c)}),800))},ajaxEnableLoadPage:()=>{let n=0;if(!s){let s;const a={success:a=>{s=setInterval((function(){const i=document.querySelector(`.${r}`),c=document.querySelector(`.${e}`);let l;if(c&&(l=c.querySelector(`.${t}`)),++n,n>5e3&&clearInterval(s),l&&i){clearInterval(s),l.insertAdjacentHTML("afterbegin",a.data.content||""),i.style.display="none";const e=a.data.pagination||"";l.insertAdjacentHTML("afterend",e);const t=document.querySelector(`.${o}`);t&&(t.innerHTML=a.data.from_to||"")}}),1)}};"number"!==l&&(c.paged=1),f(c,a)}},getFilterParams:()=>c}})(),window.lpCourseList.init(),window.lpCourseList.ajaxEnableLoadPage();